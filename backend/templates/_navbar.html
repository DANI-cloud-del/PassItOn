<header>
    <div class="logo">
  <a href="{{ url_for('home') }}" style="text-decoration: none; color: inherit;">
    <span>PassItOn</span>
  </a>
</div>

    
    <div class="search-container" style="position: relative; max-width: 500px; flex:1;">
    <input id="searchInput" type="text" class="search-bar" placeholder="Search items..." autocomplete="off"/>
    <button class="filter-btn" title="Filter Search">
        <i class="fas fa-filter"></i>
    </button>
    <ul id="searchSuggestions" style="position:absolute; background:white; list-style:none; margin:0; padding:0; width:100%; max-height:200px; overflow-y:auto; display:none; border:1px solid #ccc; border-radius:0 0 6px 6px; z-index:50;"></ul>
</div>


    <div class="nav-icons">
        <button class="icon-btn" id="themeToggle" title="Toggle Theme">
            <i class="fas fa-moon"></i>
        </button>
        
        <div class="dropdown" style="position: relative;">
            <button id="makeRequestBtn" class="icon-btn" title="Make a Request" style="background:none; border:none; color:inherit; font-size:1.3rem; cursor:pointer; padding:6px; border-radius:50%;">
                <i class="fas fa-plus-circle"></i>
                <span class="notification-badge" style="display:none;">!</span>
            </button>
            <div id="makeRequestContent" class="dropdown-content">
                <form id="requestForm" style="display:flex; flex-direction:column; gap:10px;">
                    <textarea id="requestInput" placeholder="Enter your request here..." rows="5" style="resize:vertical; padding:12px; border-radius:8px; border:1.5px solid var(--primary);"></textarea>
                    <button type="submit" class="btn-primary">Send Request</button>
                </form>
            </div>
        </div>

        <!-- Correct way to add cart link in navbar -->
<a href="{{ url_for('cart') }}" class="icon-btn" id="cartBtn" title="Cart">
    <i class="fas fa-shopping-cart"></i>
    <span class="notification-badge" id="cartCount" style="display: none;">0</span>
</a>

        {% if session.get('username') %}
  <button id="logoutBtn" class="icon-btn" title="Logout">
    Logout ({{ session.get('username') }})
  </button>
{% else %}
  <a href="{{ url_for('login') }}" style="color: inherit; text-decoration: none;" id="loginBtn" class="icon-btn" title="Login">Login</a>
{% endif %}

        <div class="dropdown icon-btn" id="notificationDropdown">
            <button id="notificationBtn" title="Notifications" style="background:none; border:none; color:inherit; font-size: 1.3rem; cursor:pointer; position: relative;">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">3</span>
            </button>
            <div class="dropdown-content" id="notificationContent" style="display:none; position: absolute; right: 0; top: 110%; background: var(--card-bg); border-radius: 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); max-width: 300px; max-height: 350px; overflow-y: auto; z-index: 25; padding: 12px; font-size: 0.9rem;">
                <ul id="notificationList" style="list-style:none; padding:0; margin:0;">
                    <!-- notifications will be dynamically loaded here -->
                </ul>
            </div>
        </div>
    </div>
</header>


<script>
    const announcementBtn = document.getElementById('announcementBtn');
    const announcementContent = document.getElementById('announcementContent');
    const announcementList = document.getElementById('announcementList');

    // Example announcements you may pass from backend or define here
    const announcements = [
        "Need a calculator for physics lab.",
        "Looking for a used ballpoint pen.",
        "Extension cords available for sharing.",
        "Offering used textbooks in good condition."
    ];

    // Populate announcement list
    announcements.forEach(text => {
        const li = document.createElement('li');
        li.textContent = text;
        announcementList.appendChild(li);
    });

    // Toggle dropdown show/hide
    announcementBtn.addEventListener('click', () => {
        if (announcementContent.style.display === 'none' || announcementContent.style.display === '') {
            announcementContent.style.display = 'block';
        } else {
            announcementContent.style.display = 'none';
        }
    });

    // Close dropdown if clicked outside
    window.addEventListener('click', function(event) {
        if (!announcementBtn.contains(event.target) && !announcementContent.contains(event.target)) {
            announcementContent.style.display = 'none';
        }
    });
</script>

<script>
    const notificationBtn = document.getElementById('notificationBtn');
    const notificationContent = document.getElementById('notificationContent');
    const notificationList = document.getElementById('notificationList');

    // Sample notification messages
    const notifications = [
        "Alice requested a calculator.",
        "New item added to Stationery Pack.",
        "Event: E-waste drive next Monday!"
    ];

    // Populate notifications list
    notifications.forEach(text => {
        const li = document.createElement('li');
        li.textContent = text;
        notificationList.appendChild(li);
    });

    // Toggle dropdown visibility on bell click
    notificationBtn.addEventListener('click', () => {
        if (notificationContent.style.display === 'block') {
            notificationContent.style.display = 'none';
        } else {
            notificationContent.style.display = 'block';
        }
    });

    // Hide dropdown if click outside
    window.addEventListener('click', (e) => {
        if (!notificationBtn.contains(e.target) && !notificationContent.contains(e.target)) {
            notificationContent.style.display = 'none';
        }
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
  const makeRequestBtn = document.getElementById("makeRequestBtn");
  const makeRequestContent = document.getElementById("makeRequestContent");
  const requestForm = document.getElementById("requestForm");
  const requestInput = document.getElementById("requestInput");

  if (!makeRequestBtn || !makeRequestContent || !requestForm || !requestInput) {
    console.error("Request form elements missing");
    return;
  }

  // Toggle dropdown visibility
  makeRequestBtn.addEventListener("click", function (e) {
    e.stopPropagation();
    makeRequestContent.classList.toggle("show");
    if (makeRequestContent.classList.contains("show")) {
      requestInput.focus();
    }
  });

  // Close dropdown when clicking outside
  document.addEventListener("click", function (e) {
    if (
      !makeRequestBtn.contains(e.target) &&
      !makeRequestContent.contains(e.target)
    ) {
      makeRequestContent.classList.remove("show");
    }
  });

  // Handle form submission with fetch POST
  requestForm.addEventListener("submit", async function (e) {
    e.preventDefault();
    const text = requestInput.value.trim();
    if (!text) {
      alert("Please enter your request");
      return;
    }

    try {
      const response = await fetch("/add_request", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text }),
      });
      const data = await response.json();

      if (data.success) {
        // Optionally update the UI with newly added request
        const notificationList = document.getElementById("notificationList");
        const li = document.createElement("li");
        li.textContent = data.request.text + " (just now)";
        notificationList.appendChild(li);

        requestInput.value = "";
        makeRequestContent.classList.remove("show");
      } else {
        alert("Error submitting request: " + data.error);
      }
    } catch (err) {
      alert("Failed to send request. Check your connection.");
      console.error(err);
    }
  });
});

</script>

<script>
    
    document.addEventListener("DOMContentLoaded", function () {
  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", function () {
      window.location.href = "/logout";
    });
  }
});

</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
            // Theme Toggle
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = themeToggle.querySelector('i');
            
            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                if (document.body.classList.contains('dark-mode')) {
                    themeIcon.classList.remove('fa-moon');
                    themeIcon.classList.add('fa-sun');
                } else {
                    themeIcon.classList.remove('fa-sun');
                    themeIcon.classList.add('fa-moon');
                }
            })});
  </script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('searchInput');
    const suggestionsBox = document.getElementById('searchSuggestions');

    searchInput.addEventListener('input', async () => {
        const query = searchInput.value.trim();
        if (query.length === 0) {
            suggestionsBox.style.display = 'none';
            suggestionsBox.innerHTML = '';
            return;
        }

        try {
            const res = await fetch(`/search_suggestions?q=${encodeURIComponent(query)}`);
            const suggestions = await res.json();

            if (suggestions.length === 0) {
                suggestionsBox.style.display = 'none';
                suggestionsBox.innerHTML = '';
                return;
            }

            suggestionsBox.innerHTML = '';
            suggestions.forEach(s => {
                const li = document.createElement('li');
                li.textContent = s.title;
                li.style.padding = '8px';
                li.style.cursor = 'pointer';
                li.addEventListener('click', () => {
                    window.location.href = `/deals?search=${encodeURIComponent(s.title)}`;
                });
                suggestionsBox.appendChild(li);
            });
            suggestionsBox.style.display = 'block';
        } catch (err) {
            console.error('Search fetch error:', err);
        }
    });

    // Hide suggestions on outside click
    document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
            suggestionsBox.style.display = 'none';
        }
    });

    // On enter key press, go to search results
    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const val = searchInput.value.trim();
            if(val.length > 0) {
                window.location.href = `/deals?search=${encodeURIComponent(val)}`;
            }
        }
    });
});

</script>

<div class="filter-dropdown" style="position: absolute; top: 40px; right: 0; background: white; border: 1px solid #ccc; border-radius: 6px; display: none; z-index: 100;">
  <div id="sortOldest" style="padding: 8px; cursor: pointer;">Sort by Oldest</div>
  <div id="sortNewest" style="padding: 8px; cursor: pointer;">Sort by Newest</div>
</div>

<script>
const filterBtn = document.querySelector('.filter-btn');
const filterDropdown = document.querySelector('.filter-dropdown');

filterBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    filterDropdown.style.display = filterDropdown.style.display === 'block' ? 'none' : 'block';
});

document.addEventListener('click', () => {
    filterDropdown.style.display = 'none';
});

document.getElementById('sortOldest').addEventListener('click', () => {
    const search = encodeURIComponent(document.getElementById('searchInput').value.trim());
    window.location.href = `/deals?search=${search}&sort=oldest`;
});

document.getElementById('sortNewest').addEventListener('click', () => {
    const search = encodeURIComponent(document.getElementById('searchInput').value.trim());
    window.location.href = `/deals?search=${search}&sort=newest`;
});
</script>
